---
title: "Measure - problems and possible solutions"
author: "Anna Kozak"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message=FALSE, error=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
library(randomForest)
library(DALEX)
library(ggplot2)
library(randomForest)
library(ceterisParibus)

```

Let consider a example

$X \sim U[0,1]$

$Y \sim Bin(40, 0.25)$

$Z \sim Exp(1)$

$W \sim U[0,1]$

$k = x*z + y.$


Now, we check the plots of density for each variable. Density computed with kernel which is "gaussian" and bandwidth is "SJ".

```{r, message=FALSE, error=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
n <- 1001
x <- runif(n)
y <- rbinom(n, 40, 1/4)
z <- rexp(n)
w <- runif(n)
k <- x*z + y
data <- data.frame(k, x, y, z, w)
new_obs <- data[1,]
data <- data[-1,]
model_rf <- randomForest(k~., data = data)
explainer_rf <- explain.default(model_rf,
                        data = data, y = data$k)

cp_rf <- ceteris_paribus(explainer_rf, observation = new_obs[2:5])
p3 <- plot(cp_rf)


variableDensity <- apply(data[, 2:5], 2, function(x){
  dx <- density(x, kernel = "gaussian", bw = "SJ")
})

gestosc <- list()
j <- 1
for(i in c(names(data))){
  gestosc[[j]] <- data.frame(cbind(variableDensity[[i]][["x"]], variableDensity[[i]][["y"]], rep(i, length(variableDensity[[i]][["x"]]))))
  j <- j + 1
}
library(plyr)
g <- ldply(gestosc, data.frame)
g$X1 <- as.numeric(as.character(g$X1))
g$X2 <- as.numeric(as.character(g$X2))

p1 <- ggplot(g, aes(x = X1, y = X2)) + geom_line() +facet_wrap(~X3, scales='free')
p1
```

With `ceteris_paribus` function from ceterisParibus package we make a Ceteris Paribus profiles.

```{r, message=FALSE, warning=FALSE, error=FALSE, include=TRUE, echo=FALSE}
p3

```


```{r, message=FALSE, warning=FALSE, error=FALSE, include=FALSE, echo=FALSE}
LocalVariableImportanceViaOscillations <- function(cp, df, absolute_deviation = TRUE, point = TRUE, density = TRUE, kernel_density = "gaussian", bw_density = "nrd0"){
  if (!(c("ceteris_paribus_explainer") %in% class(cp)))
    stop("The LocalVariableImportanceViaOscillations() function requires an object created with ceteris_paribus() function.")
  if (!c("data.frame") %in% class(df))
    stop("The LocalVariableImportanceViaOscillations() function requires a data.frame.")

  avg_yhat <- lapply(unique(cp$`_vname_`), function(x){
    mean(cp$`_yhat_`[cp$`_vname_` == x])
  })
  names(avg_yhat) <- unique(cp$`_vname_`)
  variableDensity <- apply(df[, as.vector(unique(cp$`_vname_`))], 2, function(x){
    dx <- density(x, kernel = kernel_density, bw = bw_density)
  })
  weight <- lapply(unique(cp$`_vname_`), function(x) {approx(variableDensity[[as.character(x)]][["x"]],
                                                             variableDensity[[as.character(x)]][["y"]],
                                                             xout = cp[cp$`_vname_` == x, as.character(x)])})
  names(weight) <- unique(cp$`_vname_`)
  obs <- attr(cp, "observations")

  if(absolute_deviation == TRUE){
    if(point == TRUE){
      if(density == TRUE){
        ## a=T, p=T, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sum(abs(weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - unlist(unname(obs["_yhat_"]))))
        }))
      }else{
        ## a=T, p=T, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sum(abs((cp[cp$`_vname_` == w, "_yhat_"] - unlist(unname(obs["_yhat_"])))))
        }))
      }
    }else{
      if(density == TRUE){
        ## a=T, p=F, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sum(abs(weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - avg_yhat[[m]]))
        }))
      }else{
        ## a=T, p=F, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sum(abs((cp[cp$`_vname_` == w, "_yhat_"] - avg_yhat[[w]])))
        }))
      }
    }
  }else{
    if(point == TRUE){
      if(density == TRUE){
        ## a=F, p=T, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sqrt(sum((weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - unlist(unname(obs["_yhat_"])))^2)/length(cp[cp$`_vname_` == m, "_yhat_"]))
        }))
      }else{
        ## a=F, p=T, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sqrt(sum((cp[cp$`_vname_` == w, "_yhat_"] - unlist(unname(obs["_yhat_"])))^2)/length(cp[cp$`_vname_` == w, "_yhat_"]))
        }))
      }
    }else{
      if(density == TRUE){
        ## a=F, p=F, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sqrt(sum((weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - avg_yhat[[m]])^2)/length(cp[cp$`_vname_` == m, "_yhat_"]))
        }))
      }else{
        ## a=F, p=F, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sqrt(sum((cp[cp$`_vname_` == w, "_yhat_"] - avg_yhat[[w]])^2)/(length(cp[cp$`_vname_` == w, "_yhat_"])))
        }))
      }
    }
  }

  cat("Local Variable Importance Via Oscillations with parameters: \n")
  cat("absolute_deviation = ", absolute_deviation, "\n")
  cat("point =", point, "\n")
  cat("density = ", density, "\n")
  cat("kernel_density = ", kernel_density, "\n")
  cat("bw_density = ", bw_density, "\n")
  cat("\n")
  cat("Results: \n")
  #cat(paste0(unique(cp$`_vname_`), ": ", result, "\n"))
  # lvivo <- list(absolute_deviation = absolute_deviation,
  #               point = point,
  #               density = density,
  #               kernel_density = kernel_density,
  #               bw_density = bw_density,
  #               variable_name = unique(cp$`_vname_`),
  #               result = data.frame(variable_name = unique(cp$`_vname_`), measure = result))
  lvivo = data.frame(variable_name = unique(cp$`_vname_`), measure = result)
  class(lvivo) = c("local_variable_importance", "data.frame")
  lvivo


}

```

We use the `LocalVariableImportanceViaOscillations` function to calculate local importance measure. Measure is calculate as absolute deviation, a distance from point(new observation) and with weighted based on the density of variable. Moreover the kernel density parameter is equal "gaussian" and bandwith parameter is "SJ".

```{r}
LocalVariableImportanceViaOscillations(cp_rf, data, bw_density = "SJ")

```


## A few words about how we calculated measure with density now
Let see a picture 

```{r, message=FALSE, error=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
tmp <- cp_rf[cp_rf$`_vname_`=="y",]
obs <- attr(cp_rf,  "observations")
ggplot(tmp, aes(x=y,y=`_yhat_`)) + geom_line() + geom_point(aes(x=y,y=`_yhat_`), obs) + geom_hline(yintercept = obs$`_yhat_`, col = "red") + ylim(c(0,16)) + geom_segment(aes(x = tmp[100,]$y, y = 0, xend = tmp[100,]$y, yend = tmp[100,]$`_yhat_`), data = tmp, arrow = arrow(angle = 30, length = unit(0.25, "inches"), ends = "both", type = "open")) + geom_segment(aes(x = tmp[90,]$y, y = tmp[90,]$`_yhat_`, xend = tmp[90,]$y, yend = obs$`_yhat_`), data = tmp, arrow = arrow(angle = 30, length = unit(0.25, "inches"), ends = "both", type = "open")) + annotate("text", x = c(13.75, 17.5), y=12.5, label = c("h1", "h2"))
```

The picture shows ceteris parbius profile for variable, red line is a value yhat for observation which is explain. The $h1 = h2 - yhat(observation)$ arrow shows an distance between ceteris paribus profiles and yhat for observation, $h2$ arrow shows an distance between ceteris paribus profiles and yhat is equal zero. Let denote $w$ as weight based on variable density. Now measure is calculated as $h2 \cdot w - yhat(observation).$ Maybe we shoud calculated as $h1 \cdot w.$


```{r, message=FALSE, warning=FALSE, error=FALSE, include=FALSE, echo=FALSE}
LocalVariableImportanceViaOscillations_1 <- function(cp, df, absolute_deviation = TRUE, point = TRUE, density = TRUE, kernel_density = "gaussian", bw_density = "nrd0"){
  if (!(c("ceteris_paribus_explainer") %in% class(cp)))
    stop("The LocalVariableImportanceViaOscillations() function requires an object created with ceteris_paribus() function.")
  if (!c("data.frame") %in% class(df))
    stop("The LocalVariableImportanceViaOscillations() function requires a data.frame.")

  avg_yhat <- lapply(unique(cp$`_vname_`), function(x){
    mean(cp$`_yhat_`[cp$`_vname_` == x])
  })
  names(avg_yhat) <- unique(cp$`_vname_`)
  variableDensity <- apply(df[, as.vector(unique(cp$`_vname_`))], 2, function(x){
    dx <- density(x, kernel = kernel_density, bw = bw_density)
  })
  weight <- lapply(unique(cp$`_vname_`), function(x) {approx(variableDensity[[as.character(x)]][["x"]],
                                                             variableDensity[[as.character(x)]][["y"]],
                                                             xout = cp[cp$`_vname_` == x, as.character(x)])})
  names(weight) <- unique(cp$`_vname_`)
  obs <- attr(cp, "observations")

  if(absolute_deviation == TRUE){
    if(point == TRUE){
      if(density == TRUE){
        ## a=T, p=T, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sum(abs(weight[[m]][["y"]] * (cp[cp$`_vname_` == m, "_yhat_"] - unlist(unname(obs["_yhat_"])))))
        }))
      }else{
        ## a=T, p=T, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sum(abs((cp[cp$`_vname_` == w, "_yhat_"] - unlist(unname(obs["_yhat_"])))))
        }))
      }
    }else{
      if(density == TRUE){
        ## a=T, p=F, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sum(abs(weight[[m]][["y"]] *(cp[cp$`_vname_` == m, "_yhat_"] - avg_yhat[[m]])))
        }))
      }else{
        ## a=T, p=F, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sum(abs((cp[cp$`_vname_` == w, "_yhat_"] - avg_yhat[[w]])))
        }))
      }
    }
  }else{
    if(point == TRUE){
      if(density == TRUE){
        ## a=F, p=T, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sqrt(sum((weight[[m]][["y"]] * (cp[cp$`_vname_` == m, "_yhat_"] - unlist(unname(obs["_yhat_"]))))^2)/length(cp[cp$`_vname_` == m, "_yhat_"]))
        }))
      }else{
        ## a=F, p=T, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sqrt(sum((cp[cp$`_vname_` == w, "_yhat_"] - unlist(unname(obs["_yhat_"])))^2)/length(cp[cp$`_vname_` == w, "_yhat_"]))
        }))
      }
    }else{
      if(density == TRUE){
        ## a=F, p=F, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sqrt(sum((weight[[m]][["y"]] * (cp[cp$`_vname_` == m, "_yhat_"] - avg_yhat[[m]]))^2)/length(cp[cp$`_vname_` == m, "_yhat_"]))
        }))
      }else{
        ## a=F, p=F, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sqrt(sum((cp[cp$`_vname_` == w, "_yhat_"] - avg_yhat[[w]])^2)/(length(cp[cp$`_vname_` == w, "_yhat_"])))
        }))
      }
    }
  }

  cat("Local Variable Importance Via Oscillations with parameters: \n")
  cat("absolute_deviation = ", absolute_deviation, "\n")
  cat("point =", point, "\n")
  cat("density = ", density, "\n")
  cat("kernel_density = ", kernel_density, "\n")
  cat("bw_density = ", bw_density, "\n")
  cat("\n")
  cat("Results: \n")
  #cat(paste0(unique(cp$`_vname_`), ": ", result, "\n"))
  # lvivo <- list(absolute_deviation = absolute_deviation,
  #               point = point,
  #               density = density,
  #               kernel_density = kernel_density,
  #               bw_density = bw_density,
  #               variable_name = unique(cp$`_vname_`),
  #               result = data.frame(variable_name = unique(cp$`_vname_`), measure = result))
  lvivo = data.frame(variable_name = unique(cp$`_vname_`), measure = result)
  class(lvivo) = c("local_variable_importance", "data.frame")
  lvivo


}

```

Look at local variable importance measure when we calculated as $h1\cdot w$. Now, the most important variable is $y$, other vairables have low measure. When we calcuted as $h2 \cdot w - yhat(observation)$ the most important was $z$, then $y$.

```{r}
LocalVariableImportanceViaOscillations_1(cp_rf, data, bw_density = "SJ")

```

