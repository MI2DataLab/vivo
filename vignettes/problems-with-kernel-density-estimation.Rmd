---
title: "Problems with kernel density estimation"
author: "Anna Kozak"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=FALSE, warning=FALSE, error=FALSE, message=FALSE}
LocalVariableImportanceViaOscillations <- function(cp, df, absolute_deviation = TRUE, point = TRUE, density = FALSE, kernel_density = "gaussian", bw_density = "nrd0"){
  avg_yhat <- lapply(unique(cp$`_vname_`), function(x){
    mean(cp$`_yhat_`[cp$`_vname_` == x])
  })
  names(avg_yhat) <- unique(cp$`_vname_`)
  variableDensity <- apply(df[, unique(cp$`_vname_`)], 2, function(x){
    dx <- density(x, kernel = kernel_density, bw = bw_density)
  })
  weight <- lapply(unique(cp$`_vname_`), function(x) {approx(variableDensity[[as.character(x)]][["x"]],
                                                             variableDensity[[as.character(x)]][["y"]],
                                                             xout = cp[cp$`_vname_` == x, as.character(x)])})
  names(weight) <- unique(cp$`_vname_`)
  obs <- attr(cp, "observations")

  if(absolute_deviation == TRUE){
    if(point == TRUE){
      if(density == TRUE){
        ## a=T, p=T, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sum(abs(weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - unlist(unname(obs["_yhat_"]))))
        }))
      }else{
        ## a=T, p=T, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sum(abs((cp[cp$`_vname_` == w, "_yhat_"] - unlist(unname(obs["_yhat_"])))))
        }))
      }
    }else{
      if(density == TRUE){
        ## a=T, p=F, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sum(abs(weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - avg_yhat[[m]]))
        }))
      }else{
        ## a=T, p=F, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sum(abs((cp[cp$`_vname_` == w, "_yhat_"] - avg_yhat[[w]])))
        }))
      }
    }
  }else{
    if(point == TRUE){
      if(density == TRUE){
        ## a=F, p=T, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sqrt(sum((weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - unlist(unname(obs["_yhat_"])))^2)/length(cp[cp$`_vname_` == m, "_yhat_"]))
        }))
      }else{
        ## a=F, p=T, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sqrt(sum((cp[cp$`_vname_` == w, "_yhat_"] - unlist(unname(obs["_yhat_"])))^2)/length(cp[cp$`_vname_` == w, "_yhat_"]))
        }))
      }
    }else{
      if(density == TRUE){
        ## a=F, p=F, d=T
        result <- unlist(lapply(unique(cp$`_vname_`), function(m){
          sqrt(sum((weight[[m]][["y"]] * cp[cp$`_vname_` == m, "_yhat_"] - avg_yhat[[m]])^2)/length(cp[cp$`_vname_` == m, "_yhat_"]))
        }))
      }else{
        ## a=F, p=F, d=F
        result <- unlist(lapply(unique(cp$`_vname_`), function(w){
          sqrt(sum((cp[cp$`_vname_` == w, "_yhat_"] - avg_yhat[[w]])^2)/(length(cp[cp$`_vname_` == w, "_yhat_"])))
        }))
      }
    }
  }

  cat("Local Variable Importance Via Oscillations with parameters: \n")
  cat("absolute_deviation = ", absolute_deviation, "\n")
  cat("point = ", point, "\n")
  cat("density = ", density, "\n")
  cat("kernel_density = ", kernel_density, "\n")
  cat("bw_density = ", bw_density, "\n")
  cat("\n")
  cat("Results: \n")
  cat(paste0(unique(cp$`_vname_`), ": ", result, "\n"))
  lvivo <- list(absolute_deviation = absolute_deviation,
                point = point,
                density = density,
                kernel_density = kernel_density,
                bw_density = bw_density,
                variable_name = unique(cp$`_vname_`),
                result = data.frame(variable_name = unique(cp$`_vname_`), measure = result))
  lvivo


}


plot.local_importance <- function(measure){
  df <- measure$result
  ggplot2::ggplot(df, aes(x = factor(df$variable_name , levels = df$variable_name[order(-df$measure)]), y = df$measure)) + geom_bar(stat = "identity") +
    xlab("_x_") + ylab("measure") + ggtitle("")
}

```



## Friedmann regression problem

```{r, message=FALSE, error=FALSE, warning=FALSE}
library(mlbench)
library(plyr)
library(ggplot2)

data <- mlbench.friedman1(10000)
y <- data$y
x <- data$x
df <- data.frame(y = y , x)
names(df) <- tolower(names(df))
```

#### Gaussian Kernel
```{r,  message=FALSE, error=FALSE, warning=FALSE}
variableDensity <- apply(df, 2, function(x){
  dx <- density(x)
})

## for variable x1,...,x10
gestosc <- list()
j <- 1
for(i in c(names(df)[2:11])){
  gestosc[[j]] <- data.frame(cbind(variableDensity[[i]][["x"]], variableDensity[[i]][["y"]], rep(i, length(variableDensity[[i]][["x"]]))))
  j <- j + 1
}

g <- ldply(gestosc, data.frame)
g$X1 <- as.numeric(as.character(g$X1))
g$X2 <- as.numeric(as.character(g$X2))

ggplot(g, aes(x = X1, y = X2)) + geom_line() + facet_wrap(~X3) + labs(x = "`_x_`", y = "density")

```

#### Gaussian Kernel with bw = "SJ"
```{r,  message=FALSE, error=FALSE, warning=FALSE}
variableDensity <- apply(df, 2, function(x){
  dx <- density(x, bw = "SJ")
})

##for variable x1,...,x10
gestosc1 <- list()
j1 <- 1
for(i1 in c(names(df)[2:11])){
  gestosc1[[j1]] <- data.frame(cbind(variableDensity[[i1]][["x"]], variableDensity[[i1]][["y"]], rep(i1, length(variableDensity[[i1]][["x"]]))))
  j1 <- j1 + 1
}

g1 <- ldply(gestosc1, data.frame)
g1$X1 <- as.numeric(as.character(g1$X1))
g1$X2 <- as.numeric(as.character(g1$X2))


ggplot(g1, aes(x = X1, y = X2)) + geom_line() + facet_wrap(~X3) + labs(x = "`_x_`", y = "density")

```

```{r, message=FALSE, error=FALSE, warning=FALSE}
library("DALEX")
library("randomForest")
library("ceterisParibus")
library(gridExtra)
library(grid)
set.seed(59)
```



##### Local Variable Importance Via Oscillations, kernel = "gaussian", bw = "nrd0"
```{r, message=FALSE, error=FALSE, warning=FALSE}
friedman_rf_model <- randomForest(y ~., data = df)
explainer_rf <- explain(friedman_rf_model, data = df[,2:11], y =df$y)
new_friedmann <- data.frame("y" = 8.924793, "x1" = 0.9002915, "x2" = 0.07000687, "x3" = 0.2255303,
                            "x4" = 0.3825585, "x5" = 0.2023882, "x6" = 0.389687, "x7" = 0.04077074,
                            "x8" = 0.2666487, "x9" = 0.144826, "x10" = 0.4970784)

cp_rf <- ceteris_paribus(explainer_rf, observations = new_friedmann[,2:11])

plot(cp_rf)
```


```{r}
wyn <- LocalVariableImportanceViaOscillations(cp_rf, absolute_deviation = TRUE, point = TRUE, density = TRUE, df[,2:11])

plot.local_importance(wyn)
```


##### Local Variable Importance Via Oscillations, kernel = "gaussian", bw = "SJ" [link](https://www.researchgate.net/publication/224817413_A_Reliable_Data-Based_Bandwidth_Selection_Method_for_Kernel_Density_Estimation)

```{r}
wyn1 <- LocalVariableImportanceViaOscillations(cp_rf, absolute_deviation = TRUE, point = TRUE, density = TRUE, df[,2:11], bw_density = "SJ")
plot.local_importance(wyn1)
```





## Apartments data 
```{r, warning=FALSE, error=FALSE, message=FALSE}
data(apartments)
apartments_rf_model <- randomForest(m2.price ~ construction.year + surface + floor +
                                       no.rooms, data = apartments)

explainer_rf <- explain(apartments_rf_model,
                        data = apartmentsTest[,2:5], y = apartmentsTest$m2.price)
new_apartment <- apartmentsTest[1, ]
new_apartment
cp_rf <- ceteris_paribus(explainer_rf, observation = new_apartment[,2:5])
plot(cp_rf)
```

### Density of variable

#### Histogram
```{r}
dane_ <- list()
j <- 1
for(i in names(apartments)){
  dane_[[j]] <- data.frame(cbind(apartments[,i], rep(i, nrow(apartments))))
  j <- j +1
}

dane_1 <- ldply(dane_, data.frame)
dane_1$X1 <- as.numeric(as.character(dane_1$X1))

ggplot(dane_1, aes(x=X1)) + geom_histogram(bins=100) + facet_wrap(~X2, scales = "free") + labs(x = "`_x_`", y = "count")

```

#### Density with gaussian kernel 

```{r}
data("apartments")

variableDensity <- apply(apartments[1:5], 2, function(x){
  dx <- density(x, kernel = "gaussian")
})

gestosc <- list()
j <- 1
for(i in c(names(apartments)[1:5])){
  gestosc[[j]] <- data.frame(cbind(variableDensity[[i]][["x"]], variableDensity[[i]][["y"]], rep(i, length(variableDensity[[i]][["x"]]))))
  j <- j + 1
}

g <- ldply(gestosc, data.frame)
g$X1 <- as.numeric(as.character(g$X1))
g$X2 <- as.numeric(as.character(g$X2))

ggplot(g, aes(x = X1, y = X2)) + geom_line() +facet_wrap(~X3, scales='free')
```

#### Density with gaussian kernel and bw = SJ

```{r}
data("apartments")

variableDensity <- apply(apartments[1:5], 2, function(x){
  dx <- density(x, kernel = "gaussian", bw = "SJ")
})

gestosc <- list()
j <- 1
for(i in c(names(apartments)[1:5])){
  gestosc[[j]] <- data.frame(cbind(variableDensity[[i]][["x"]], variableDensity[[i]][["y"]], rep(i, length(variableDensity[[i]][["x"]]))))
  j <- j + 1
}

g <- ldply(gestosc, data.frame)
g$X1 <- as.numeric(as.character(g$X1))
g$X2 <- as.numeric(as.character(g$X2))

ggplot(g, aes(x = X1, y = X2)) + geom_line() +facet_wrap(~X3, scales='free')
```


##### Local Variable Importance Via Oscillations, kernel = "gaussian", bw = "nrd0"


```{r}
wyn <- LocalVariableImportanceViaOscillations(cp_rf, absolute_deviation = TRUE, point = TRUE, density = TRUE, apartments[,2:5])
plot.local_importance(wyn)
```


##### Local Variable Importance Via Oscillations, kernel = "gaussian", bw = "SJ" [link](https://www.researchgate.net/publication/224817413_A_Reliable_Data-Based_Bandwidth_Selection_Method_for_Kernel_Density_Estimation)

```{r}
wyn1 <- LocalVariableImportanceViaOscillations(cp_rf, absolute_deviation = TRUE, point = TRUE, density = TRUE, apartments[,2:5], bw_density = "SJ")
plot.local_importance(wyn1)
```


#### Example

```{r}
n <- 1001
x1 <- runif(n)
x2 <- rbinom(n, 40, 1/4)
x3 <- rexp(n)
x4 <- runif(n)
y <- x1*x3 + x2
data <- data.frame(y, x1, x2, x3, x4)
new_obs <- data[1,]
data <- data[-1,]
model_rf <- randomForest(y~., data = data)
explainer_rf <- explain(model_rf,
                        data = data, y = data$y)

cp_rf <- ceteris_paribus(explainer_rf, observation = new_obs[2:5])
plot(cp_rf)

```

```{r}
wyn <- LocalVariableImportanceViaOscillations(cp_rf, absolute_deviation = TRUE, point = TRUE, density = TRUE, data[,2:5])
plot.local_importance(wyn)
```


```{r}
wyn1 <- LocalVariableImportanceViaOscillations(cp_rf, absolute_deviation = TRUE, point = TRUE, density = TRUE, data[,2:5], bw_density = "SJ")
plot.local_importance(wyn1)
```

```{r}


variableDensity <- apply(data, 2, function(x){
  dx <- density(x, kernel = "gaussian", bw = "SJ")
})

gestosc <- list()
j <- 1
for(i in c(names(data))){
  gestosc[[j]] <- data.frame(cbind(variableDensity[[i]][["x"]], variableDensity[[i]][["y"]], rep(i, length(variableDensity[[i]][["x"]]))))
  j <- j + 1
}

g <- ldply(gestosc, data.frame)
g$X1 <- as.numeric(as.character(g$X1))
g$X2 <- as.numeric(as.character(g$X2))

ggplot(g, aes(x = X1, y = X2)) + geom_line() +facet_wrap(~X3, scales='free')
```
